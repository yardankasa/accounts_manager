# رزابوت‌ها (Rezabots) — راهنمای کامل پروژه

بات ادمین تلگرام برای **مدیریت ورود اکانت‌های تلگرام** روی یک سرور اصلی و نودهای SSH. هر اکانت با API_ID/API_HASH خودش (واردشده در بات) کار می‌کند. سشن‌ها روی سرور اصلی یا نود انتخاب‌شده ذخیره می‌شوند. علاوه بر ورود و مدیریت نود/اکانت، قابلیت **رفتار انسانی (Humantic)** برای شبیه‌سازی کاربر عادی (جوین/ترک کانال و گروه، ارسال پیام خصوصی) با تأخیرها و بازه‌های تصادفی وجود دارد.

---

## فهرست

- [پیش‌نیازها](#پیش‌نیازها)
- [شروع سریع (اجرای آسان بات)](#شروع-سریع-اجرای-آسان-بات)
- [ساختار پروژه](#ساختار-پروژه)
- [نحوه کار بات](#نحوه-کار-بات)
- [رفتار انسانی (مدیریت رفتار انسانی)](#رفتار-انسانی-مدیریت-رفتار-انسانی)
- [معماری و جریان ورود](#معماری-و-جریان-ورود)
- [محدودیت‌ها و قوانین](#محدودیت‌ها-و-قوانین)
- [هشدارها و نکات امنیتی](#هشدارها-و-نکات-امنیتی)
- [عیب‌یابی](#عیب‌یابی)

---

## پیش‌نیازها

| مورد | نسخه / توضیح |
|------|----------------|
| **Python** | ۳.۱۳ یا بالاتر |
| **MySQL** | ۸ یا ۵.۷ |
| **توکن بات** | از [@BotFather](https://t.me/BotFather) |
| **نودهای دیگر** | دسترسی SSH (کلید یا پسورد) به سرورهای دیگر |

---

## شروع سریع (اجرای آسان بات)

### ۱. ورود به پوشه پروژه

```bash
cd /path/to/rezabots/src
```

تمام دستورات زیر از داخل همین پوشه `src` اجرا می‌شوند (جایی که `main.py` و پوشه‌های `core` و `bot` هستند).

### ۲. محیط مجازی و نصب وابستگی‌ها

```bash
python3 -m venv .venv
source .venv/bin/activate          # لینوکس/مک
# در ویندوز: .venv\Scripts\activate

pip install -e .
```

### ۳. راه‌اندازی MySQL

از **ریشه پروژه** (یک سطح بالاتر از `src`):

```bash
cd ..   # برگشت به ریشه پروژه
./scripts/install_mysql.sh
```

این اسکریپت در دبیان/اوبونتو MySQL را نصب می‌کند، دیتابیس `rezabots` و کاربر `rezabots` را می‌سازد و متغیرهای `MYSQL_*` را به `.env` اضافه می‌کند. در صورت تمایل قبل از اجرا می‌توانید `MYSQL_APP_PASSWORD=پسوردخود` تنظیم کنید.

### ۴. تنظیم محیط (فایل `.env`)

فایل `.env` باید در **همان پوشه‌ای که `main.py` است** (یعنی `src`) قرار بگیرد:

```bash
cd /path/to/rezabots/src
cp .env.example .env
```

سپس `.env` را ویرایش کنید:

| متغیر | اجباری | توضیح |
|--------|--------|--------|
| `BOT_TOKEN` | بله | توکن بات از [@BotFather](https://t.me/BotFather) |
| `ADMIN_IDS` | بله | شناسه عددی تلگرام ادمین‌ها با کاما (مثلاً `123456789,987654321`) |
| `MYSQL_HOST` | بله | معمولاً `127.0.0.1` |
| `MYSQL_PORT` | بله | معمولاً `3306` |
| `MYSQL_USER` | بله | معمولاً `rezabots` |
| `MYSQL_PASSWORD` | بله | پسورد MySQL |
| `MYSQL_DATABASE` | بله | معمولاً `rezabots` |
| `BOT_USERNAME` | خیر | نام بات بدون @ (برای im_alive) |
| `IM_ALIVE_CHANNEL_ID` | خیر | شناسه عددی کانال برای لاگ زنده بودن و رفتار انسانی (بات باید ادمین کانال باشد) |
| `PROXY_URL` | خیر | در صورت نیاز پروکسی، مثلاً `socks5://127.0.0.1:10808` |

**API_ID و API_HASH** از `.env` خوانده نمی‌شوند؛ ادمین در بات برای هر ورود آن‌ها را وارد می‌کند.

### ۵. اجرای بات (دستور نهایی)

همیشه از داخل پوشه `src` و با فعال بودن venv:

```bash
cd /path/to/rezabots/src
source .venv/bin/activate
python main.py
```

یا با اسکریپت نصب‌شده از `pyproject.toml`:

```bash
cd /path/to/rezabots/src
source .venv/bin/activate
rezabots
```

یا از ریشه پروژه با تنظیم مسیر پایتون:

```bash
cd /path/to/rezabots
PYTHONPATH=src src/.venv/bin/python src/main.py
```

با اجرای موفق، بات جدول‌ها و نود اصلی را در دیتابیس ایجاد می‌کند، ادمین‌ها را از `ADMIN_IDS` پر می‌کند و شروع به polling می‌کند. مسیر فایل لاگ در خروجی چاپ می‌شود (مثلاً `logs/bot_errors.log`).

### ۶. استفاده از بات

1. به بات **`/admin`** بفرستید.
2. اگر شناسه شما در `ADMIN_IDS` باشد، پنل ادمین نمایش داده می‌شود.
3. **ورود اکانت:** از منو «ورود به اکانت» → انتخاب نود → وارد کردن **API_ID** → **API_HASH** → شماره تلفن → کد تأیید (و در صورت فعال بودن، رمز دو مرحله‌ای). سشن روی نود انتخاب‌شده ذخیره می‌شود.

---

## ساختار پروژه (زیر `src/`)

| مسیر | کاربرد |
|------|--------|
| `main.py` | نقطه ورود: لاگ، اتصال DB، ثبت هندلرها و job رفتار انسانی، `run_polling()` |
| `core/config.py` | خواندن `.env`، BOT_TOKEN، MYSQL_*، مسیرها |
| `core/db.py` | اتصال MySQL، جداول، admins/nodes/accounts/login_events، تنظیمات و خواب رفتار انسانی |
| `core/limits.py` | محدودیت تعداد ورود در روز و فاصله بین ورودها |
| `core/node_runner.py` | اجرای ورود روی نود اصلی (Telethon) یا نود دور (SSH + اسکریپت) |
| `core/telethon_login.py` | ورود Telethon روی سرور اصلی |
| `bot/handlers_admin.py` | `/admin`، بازگشت/انصراف |
| `bot/handlers_login.py` | مکالمه ورود: نود → API_ID → API_HASH → تلفن → کد → 2FA |
| `bot/handlers_accounts.py` | لیست اکانت‌ها، حذف، وضعیت، im_alive |
| `bot/handlers_nodes.py` | لیست نودها، افزودن/حذف نود |
| `bot/handlers_humantic.py` | پنل «مدیریت رفتار انسانی» و callback دکمه‌ها |
| `bot/keyboards.py` | کیبوردهای فارسی |
| `bot/messages.py` | متن‌های کاربری فارسی |
| `bot/filters.py` | `ensure_admin()` |
| `cli_bots/humantic_actions/` | رانر رفتار انسانی، اکشن‌ها، state، لاگ کانال |
| `cli_bots/grand_policy.py` | سیاست کلی: فاصله تصادفی بین اکشن هر اکانت |
| `data/links_pool/` | `channels.json`, `chats.json`, `pv.json` برای لینک‌های جوین/ترک/پیوی |
| `data/session/` | سشن‌های نود اصلی |
| `data/humantic_state.json` | وضعیت توقف/ادامه اجرای رفتار انسانی |
| `logs/` | لاگ بات |

---

## نحوه کار بات

- **ورود:** فقط کاربرانی که شناسه آن‌ها در جدول `admins` است (از `ADMIN_IDS` پر می‌شود) به پنل `/admin` دسترسی دارند.
- **ورود اکانت:** انتخاب نود → API_ID و API_HASH و شماره تلفن → کد و در صورت نیاز 2FA. پس از موفقیت، رکورد در `accounts` و `login_events` ثبت و سشن روی همان نود ذخیره می‌شود.
- **نود اصلی:** به‌صورت خودکار ساخته می‌شود؛ سشن‌ها در `data/session/` روی همان سرور هستند.
- **نودهای دیگر:** از منو «مدیریت نودها» با نام، host، پورت، کاربر SSH و مسیر سشن روی نود اضافه می‌شوند. اسکریپت ورود از طریق SSH روی نود اجرا می‌شود.

---

## رفتار انسانی (مدیریت رفتار انسانی)

این بخش برای **شبیه‌سازی کاربر عادی** است تا ریسک محدودیت/بن کاهش یابد: جوین و ترک کانال/گروه و ارسال یک پیام به لینک‌های PV، با **بازه‌های تصادفی** و بدون اینکه همه اکانت‌ها در یک زمان مشخص یک کار را انجام دهند.

### تنظیمات (همه به صورت بازه x تا n)

- **فاصله اجرا:** هر چند ساعت یک بار اجرا (مثلاً ۴–۶، ۸–۱۲، ۲۴–۳۰ ساعت؛ مقدار واقعی هر بار تصادفی در بازه).
- **ترک کانال/گروه:** پس از چند ساعت ترک شود (مثلاً ۱–۳، ۲–۶، ۲۵–۳۰ ساعت).
- **خواب اکانت (فلو):** اگر یک اکانت فلو/محدودیت بخورد، چند روز در خواب (بازه مثلاً ۳–۵ روز).
- **خواب سیستم (فلو):** اگر چند اکانت در یک اجرا فلو بخورند، کل سیستم چند ساعت در خواب (بازه مثلاً ۰.۵–۲ ساعت).

همه زمان‌ها به صورت **بازه (min–max)** و **تصادفی** اعمال می‌شوند تا هیچ‌وقت همه در یک زمان ثابت جوین/ترک/پیام نزنند.

### روش اجرا

- **از طریق بات:** در پنل ادمین دکمه «مدیریت رفتار انسانی» → روشن کردن و انتخاب بازه‌ها. یک job هر ۵ دقیقه چک می‌کند؛ اگر رفتار انسانی روشن باشد و زمان بازه گذشته باشد، یک بار `run_all_accounts` اجرا می‌شود.
- **از طریق CLI (دستی):**

```bash
cd /path/to/rezabots/src
source .venv/bin/activate
python -m cli_bots.humantic_actions
```

این دستور فقط اکانت‌های **نود اصلی** را از DB می‌خواند و به‌صورت یکی‌یکی برای هر اکانت لیست اکشن‌ها (جوین کانال، جوین چت، پیوی، ترک کانال، ترک چت) را به‌صورت **ترتیب تصادفی** (با seed ثابت برای هر run) اجرا می‌کند. بین هر اکشن یک تأخیر تصادفی (مثلاً ۱۵–۴۵ ثانیه) و طبق grand policy یک فاصله تصادفی per-account (۰.۸–۱.۵ ثانیه) رعایت می‌شود.

### لینک‌ها و state

- لینک‌ها از `data/links_pool/channels.json`, `chats.json`, `pv.json` خوانده می‌شوند.
- وضعیت اجرا در `data/humantic_state.json` ذخیره می‌شود. اگر اسکریپت قطع شود، اجرای بعدی از همان نقطه ادامه می‌دهد (بدون جوین/پیوی تکراری). state فقط برای runهای شروع‌شده در ۲ ساعت گذشته معتبر است.
- اگر `IM_ALIVE_CHANNEL_ID` و `BOT_TOKEN` تنظیم شده باشند، خلاصه هر run و هر اکانت و هر اکشن به آن کانال با بات ارسال می‌شود.

### فلو و خواب

- اگر فقط **یک اکانت** فلو/PEER_FLOOD بگیرد → آن اکانت برای یک مدت تصادفی در بازه «خواب اکانت» (مثلاً ۳–۵ روز) از اجرا حذف می‌شود.
- اگر **چند اکانت** در همان run فلو بگیرند → «خواب سیستم» فعال می‌شود (مدت تصادفی در بازه، مثلاً ۰.۵–۲ ساعت) و به ادمین‌ها اطلاع داده می‌شود.

---

## معماری و جریان ورود

```
┌─────────────────────────────────────────────────────────────────┐
│  سرور اصلی                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐     │
│  │  بات ادمین   │  │  Core        │  │  MySQL               │     │
│  │  (ptb v21)   │──│  DB, limits, │──│  admins, nodes,       │     │
│  │  منوی فارسی  │  │  node_runner,│  │  accounts,            │     │
│  │  + رفتار     │  │  telethon_   │  │  humantic_settings    │     │
│  │  انسانی     │  │  login       │  │  login_events         │     │
│  └──────┬───────┘  └──────┬───────┘  └──────────────────────┘     │
│         │                 │                                        │
│         │                 │  SSH (برای نود دور)                   │
│         │                 │  آپلود اسکریپت ورود، اجرا با env      │
└─────────┼─────────────────┼────────────────────────────────────────┘
          │                 │
          ▼                 ▼
    ┌───────────┐    ┌─────────────────────────────────────────────┐
    │  ادمین‌ها  │    │  نودها (اختیاری)                            │
    │  تلگرام   │    │  سرور SSH: اجرای اسکریپت ورود، سشن در مسیر  │
    └───────────┘    └─────────────────────────────────────────────┘
```

---

## محدودیت‌ها و قوانین

- **ورود:** حداکثر **۳ بار ورود در ۲۴ ساعت** به ازای هر نود؛ حداقل **۴ ساعت** بین دو ورود روی **همان نود**.
- **مکالمه ورود:** فقط یک مکالمه ورود فعال به ازای هر کاربر؛ کد اشتباه با پیام واضح نمایش داده می‌شود و مرحله کد تکرار می‌شود.
- **رفتار انسانی:** فقط اکانت‌های **نود اصلی** در نسخه فعلی در اجرای خودکار/CLI استفاده می‌شوند. اکانت‌ها باید `api_id` و `api_hash` داشته باشند (از زمان ورود در بات ست می‌شوند).
- **Grand policy:** بین هر اکشن هر اکانت یک فاصله تصادفی (۰.۸–۱.۵ ثانیه) رعایت می‌شود تا همه با هم در یک ثانیه اکشن نزنند.
- **تأخیر بین جوین/مراحل:** در بازه‌های ثابت در `cli_bots/humantic_actions/config.py` (مثلاً ۱۵–۴۵ ثانیه بین جوین‌ها).

---

## هشدارها و نکات امنیتی

1. **توکن و شناسه ادمین:** `BOT_TOKEN` و `ADMIN_IDS` را در `.env` قرار دهید و `.env` را در git کامیت نکنید.
2. **دیتابیس:** پسورد MySQL را قوی نگه دارید و دسترسی دیتابیس را به شبکه‌های غیرضروری محدود کنید.
3. **تلگرام:** استفاده بیش از حد از API (ورودهای پشت‌سرهم، جوین/ترک انبوه) می‌تواند به محدودیت موقت یا مسدودی منجر شود. رفتار انسانی با بازه‌های تصادفی و تأخیر برای کاهش این ریسک طراحی شده، اما تضمینی وجود ندارد.
4. **فلو/PEER_FLOOD:** در صورت فلو، اکانت یا کل سیستم طبق تنظیمات پنل به‌صورت خودکار به خواب می‌روند؛ پس از خواب دوباره اجرا از سر گرفته می‌شود.
5. **پروکسی:** در محیط‌هایی که به API تلگرام دسترسی مستقیم ندارید، از `PROXY_URL` (مثلاً socks5) استفاده کنید.
6. **لاگ:** لاگ‌ها ممکن است حاوی شناسه چت، شماره (مختصر) و لینک‌ها باشند؛ مسیر لاگ و دسترسی به سرور را محدود کنید.

---

## عیب‌یابی

### پیدا کردن شناسه کاربر تلگرام

به [@userinfobot](https://t.me/userinfobot) پیام بفرستید یا موقتاً در بات `print(update.effective_user.id)` قرار دهید و `/admin` بفرستید. عدد را در `ADMIN_IDS` در `.env` قرار دهید.

### ساخت بات و دریافت BOT_TOKEN

از [@BotFather](https://t.me/BotFather) بات بسازید و توکن را در `BOT_TOKEN` قرار دهید.

### API_ID و API_HASH (برای هر اکانت)

از [my.telegram.org](https://my.telegram.org) یک اپلیکیشن بسازید و API ID و API Hash بگیرید. ادمین در بات هنگام شروع ورود (بعد از انتخاب نود) آن‌ها را وارد می‌کند.

### بات به `/admin` جواب نمی‌دهد

- `BOT_TOKEN` و اجرا بودن پروسه را چک کنید.
- مطمئن شوید شناسه شما در `ADMIN_IDS` (با کاما، بدون فاصله اضافه در صورت تمایل) است.
- `logs/bot_errors.log` و خروجی ترمینال را برای خطا (مثلاً اتصال DB) ببینید.

### TimedOut / «اتصال به تلگرام برقرار نشد»

در صورت timeout یا قطع شبکه، بات پیام کوتاه فارسی می‌فرستد. اگر مدام timeout می‌گیرید، احتمالاً فایروال یا مسدودیت است؛ از پروکسی (مثلاً `PROXY_URL` یا `HTTPS_PROXY`) استفاده کنید. برای SOCKS5 پکیج با socks نصب شده است (`python-telegram-bot[socks]`).

### اجرای دستی رفتار انسانی

```bash
cd /path/to/rezabots/src
source .venv/bin/activate
python -m cli_bots.humantic_actions
```

اگر لینکی در `data/links_pool/` نباشد یا اکانتی سشن/API نداشته باشد، آن قسمت در لاگ skip می‌شود.

### ریست دیتابیس

جداول در اولین اجرا ساخته می‌شوند. برای ریست می‌توانید دیتابیس را drop و دوباره اجرا کنید یا جداول را خالی کنید؛ در صورت خالی بودن `nodes`، نود اصلی دوباره ساخته می‌شود.

---

## خلاصه دستورات (اجرای آسان)

| مرحله | محل | دستور / کار |
|--------|-----|-------------|
| وابستگی‌ها | `src` | `pip install -e .` |
| MySQL | ریشه پروژه | `./scripts/install_mysql.sh` |
| محیط | `src` | `cp .env.example .env` و تنظیم `BOT_TOKEN`, `ADMIN_IDS`, `MYSQL_*` |
| اجرای بات | `src` | `source .venv/bin/activate` سپس `python main.py` یا `rezabots` |
| رفتار انسانی (دستی) | `src` | `python -m cli_bots.humantic_actions` |
| استفاده | تلگرام | ارسال `/admin` و استفاده از منوی فارسی |

API_ID و API_HASH همیشه در بات و برای هر بار ورود توسط ادمین وارد می‌شوند، نه از طریق `.env`.
